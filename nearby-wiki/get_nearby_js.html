<!DOCTYPE html>
<html>

<head>
  <title>Wikitrip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i,700,700i|Playfair+Display|Roboto+Slab&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>
  <div class="container-fluid" id="main-container">
      <div class="row title">
        <h1 class="mx-4 my-2">Wikitrip</h1>
      </div>
      <div class="container px-2">
      <div class="row pt-5">
        <div class="col card">
          <h2 class="" id="location">Click to show articles in your location
          </h2>
          <button id="button" onclick="getArticles(getLocation)">Get Articles</button>
          <p id="articles"></p>
        </div>
      </div>
      <div class="row pt-3" id="content">
      </div>
    </div>
  </div>



</body>

<script>
  function getArticles() {
    getLocation(function(lat_lng) {
      var pos = lat_lng;

      document.getElementById("location").innerHTML = "Your location is " + pos.lat.toFixed(2) + " N, " + pos.lng.toFixed(2) + " W";
      document.getElementById("button").innerHTML = "Get new articles";
      //var location = position.lat + "|" + getLocation().lng

      var url = "https://en.wikipedia.org/w/api.php";

      var params = {
        action: "query",
        list: "geosearch",
        gscoord: pos.lat.toString() + "|" + pos.lng.toString(),
        gsradius: "10000",
        gslimit: "10",
        format: "json"
      };

      // We're appending the keys and info to create an api query url. e.g. https://en.wikipedia.org/w/api.php?origin=*&action=query&list=geosearch&gscoord=37.7891838|-122.4033522&gsradius=10000&gslimit=10&format=json
      url = url + "?origin=*";

      // For each key in the params, append the key and value to the url
      Object.keys(params).forEach(function(key) {
        url += "&" + key + "=" + params[key];
      });


      // Use the URL defined above to make a query to the wikipedia api and return the json response
      fetch(url)
        .then(function(response) {
          return response.json();
        })
        .then(function(response) {
          var pages = response.query.geosearch;

          for (var place in pages) {
            console.log(pages[place].title);
            getArticleIntro(pages[place].title, writeCard);
          };
        })
        .catch(function(error) {
          console.log(error);
        });
    });
  }
</script>

<script>
  var x = document.getElementById("location");

  function getLocation(callback) {
    if (navigator.geolocation) {
      var lat_lng = navigator.geolocation.getCurrentPosition(function(position) {
        console.log(position);
        var user_position = {};
        user_position.lat = position.coords.latitude;
        user_position.lng = position.coords.longitude;
        callback(user_position);
      });
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }
</script>

<script>
  function getArticleIntro(title, callback) {
    var url = "https://en.wikipedia.org/w/api.php";
    var params = {
      action: "query",
      format: "json",
      titles: title,
      prop: "extracts|pageimages",
      piprop: "thumbnail",
      pithumbsize: "250",
      exintro: "True",
      explaintext: "True"
    };

    // We're appending the keys and info to create an api query url. e.g. https://en.wikipedia.org/w/api.php?origin=*&action=query&list=geosearch&gscoord=37.7891838|-122.4033522&gsradius=10000&gslimit=10&format=json
    url = url + "?origin=*";

    // For each key in the params, append the key and value to the url
    Object.keys(params).forEach(function(key) {
      url += "&" + key + "=" + params[key];
    });

    fetch(url)
      .then(function(response) {
        return response.json();
      })
      .then(function(response) {
        var pages = response.query.pages;
        var articleID = Object.keys(pages);
        var article = pages[articleID];
        var text = article["extract"];
        var img = article["thumbnail"].source;
        console.log(img);
        var title = article.title;
        console.log(title)
        callback(title, text, img);
      })
      .catch(function(error) {
        console.log(error);
      });



  }

  function writeCard(title, text, img) {
    console.log(title)
    console.log(text)
    var newDiv = document.createElement("div");
    newDiv.setAttribute("class", "col-md-6 col-xs-12 my-2");
    var intDiv = document.createElement("div");
    intDiv.setAttribute("class", "col-12 card");
    newDiv.appendChild(intDiv);

    var header = document.createElement("h2");
    intDiv.appendChild(header);

    var newContent = document.createTextNode(title);
    header.appendChild(newContent);

    var image = document.createElement("img");


    var intro = document.createElement("p")
    image.setAttribute("src", img);
    image.setAttribute("style", "width: 50%; float: left; padding-right: 5%; padding-top: 1.5%");
    intro.appendChild(image);
    var articleText = document.createTextNode(text);
    intro.appendChild(articleText);
    intDiv.appendChild(intro);

    var currentDiv = document.getElementById("content");
    currentDiv.appendChild(newDiv);
  }
</script>


</html>
